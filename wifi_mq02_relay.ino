#include <ESP8266WiFi.h>
#include <ESP8266WebServer.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64

const char* ssid = "YOUR_WIFI_NETWORK_SSID";
const char* password = "YOUR_WIFI_PASSWORD";  

const int mq2Pin = A0;
const int relayPin = D5;

const int gasThreshold = 400;

// Provided Kitkraft.in logo bitmap (64x64)
const unsigned char epd_bitmap_new_logo_24_white_bl [] PROGMEM = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x01, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x01, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x01, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x01, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 
    0x01, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 
    0x01, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 
    0x01, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 
    0x01, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0x00, 0x03, 0xc0, 0x00, 0x00, 
    0x01, 0xff, 0xfe, 0x00, 0x0f, 0xf0, 0x00, 0x00, 0x01, 0xff, 0xf8, 0x00, 0x3f, 0xfc, 0x00, 0x00, 
    0x01, 0xff, 0xe0, 0x00, 0xff, 0xfe, 0x00, 0x00, 0x01, 0xff, 0xc0, 0x01, 0xff, 0xff, 0x80, 0x00, 
    0x01, 0xff, 0x00, 0x07, 0xff, 0xff, 0xe0, 0x00, 0x01, 0xfc, 0x00, 0x1f, 0xff, 0xff, 0xf8, 0x00, 
    0x00, 0xf8, 0x00, 0x3f, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x00, 
    0x00, 0x00, 0x03, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x07, 0xff, 0xff, 0xff, 0xff, 0xe0, 
    0x00, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xe0, 
    0x00, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x07, 0xff, 0xff, 0xff, 0xff, 0xc0, 
    0x00, 0x00, 0x03, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x00, 
    0x00, 0x60, 0x00, 0x7f, 0xff, 0xff, 0xfc, 0x00, 0x00, 0xf8, 0x00, 0x1f, 0xff, 0xff, 0xf0, 0x00, 
    0x01, 0xfe, 0x00, 0x07, 0xff, 0xff, 0xe0, 0x00, 0x01, 0xff, 0x80, 0x01, 0xff, 0xff, 0x80, 0x00, 
    0x01, 0xff, 0xe0, 0x00, 0xff, 0xfe, 0x00, 0x00, 0x01, 0xff, 0xf0, 0x00, 0x3f, 0xfc, 0x00, 0x00, 
    0x01, 0xff, 0xfc, 0x00, 0x0f, 0xf0, 0x00, 0x00, 0x01, 0xff, 0xff, 0x00, 0x03, 0xc0, 0x00, 0x00, 
    0x01, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 
    0x01, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 
    0x01, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 
    0x01, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 
    0x01, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 
    0x01, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x01, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x01, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);
ESP8266WebServer server(80);

int gasValue = 0;

void drawLogo() {
  display.clearDisplay();
  display.drawBitmap((SCREEN_WIDTH-64)/2, 0, epd_bitmap_new_logo_24_white_bl, 64, 64, SSD1306_WHITE);
  display.display();
  delay(2000);
}

void updateOLED(int gasVal) {
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(0,0);
  display.println("Kitkraft.in");
  display.println("MQ-2 Gas Sensor");
  int barWidth = map(gasVal, 0, 1023, 0, 120);
  display.drawRect(3, 20, 122, 12, SSD1306_WHITE);
  display.fillRect(4, 21, barWidth, 10, SSD1306_WHITE);
  display.setCursor(0,35);
  display.setTextSize(1);
  display.print("Level: ");
  display.println(gasVal);
  if (gasVal >= gasThreshold) {
    display.drawTriangle(110,48,125,48,117,60,SSD1306_WHITE);
    display.setCursor(20,50);
    display.setTextSize(2);
    display.println("ALERT!");
  } else {
    display.setCursor(30,50);
    display.setTextSize(2);
    display.println("Normal");
  }
  display.display();
}

const char webpage[] PROGMEM = R"rawliteral(
<!DOCTYPE HTML>
<html>
<head>
<title>Kitkraft.in - MQ-2 Gas Sensor Monitor</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="refresh" content="2">
<style>
  body { font-family: Arial, sans-serif; background: #f4f4f4; margin:0; padding: 0 5vw; }
  img.logo { width: 35vw; max-width: 120px; margin: 10px auto; display: block; }
  h1 { color: #222; font-size: 2rem; text-align:center;}
  .reading { font-size: 2.5em; margin: 16px 0; text-align: center; font-weight: 600;}
  
  .status-display {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 12px 0;
    gap:8px;
    flex-wrap:wrap;
    padding: 10px;
    border-radius: 10px;
    background: #2222;
  }
  .status-icon {
    width: 45px; height: 45px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    background: %BARCOLOR%;
    color: #fff;
    font-size:2em;
    box-shadow: 0 2px 6px #8881;
  }
  .status-text { font-size: 1.4em; font-weight: 500; }
  
  .bar-container {
    width: 100%;
    max-width:480px;
    background: #ddd;
    border-radius: 10px;
    overflow: hidden;
    height: 32px;
    margin: 0 auto 8px auto;
  }
  .bar {
    height: 32px;
    transition: width 1s ease;
  }
  
  .alert-banner, .normal-banner {
    padding: 10px; font-weight: bold; margin-top:12px; text-align:center;
    border-radius:7px;
    font-size:1.15em;
  }
  .alert-banner { background-color: #D32F2F; color: #fff }
  .normal-banner { background-color: #388E3C; color: #fff }

  @media (max-width: 600px) {
    img.logo { width: 60vw; max-width: 90px; }
    h1 { font-size: 1.3rem; }
    .reading { font-size: 1.5em; }
    .bar-container { height: 24px; }
    .status-icon { width: 32px; height: 32px; font-size:1.35em;}
    .status-text { font-size:1em;}
  }
</style>
</head>
<body>
<img src="https://cdn.shopify.com/s/files/1/0637/1908/0075/files/new_logo_square_1000_1000.png" alt="Kitkraft.in Logo" class="logo"/>
<h1>Kitkraft.in - MQ-2 Gas Sensor Real-time Reading</h1>
<div class='reading'>Gas Value: <span id='gasValue'>%GAS_VALUE%</span></div>

<div class='status-display'>
  <div class='status-icon'>%STATUS_ICON%</div>
  <div class='status-text'>%GAS_STATUS_TEXT%</div>
</div>

<div class='bar-container'>
  <div class='bar' style='width:%PERCENT%%; background-color:%BARCOLOR%;'></div>
</div>
<div style="text-align:center; margin-top:6px;">
  <strong>Exhaust status:</strong> %EXHAUST_STATUS%
</div>
%ALERT%
</body>
</html>
)rawliteral";

void setup(){
  Serial.begin(115200);
  delay(1000);
  pinMode(mq2Pin, INPUT);
  pinMode(relayPin, OUTPUT);
  digitalWrite(relayPin, LOW);
  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)){
    Serial.println(F("SSD1306 allocation failed"));
    while(true);
  }
  drawLogo();

  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, password);
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(0,0);
  display.println("Connecting to WiFi...");
  display.display();

  while(WiFi.status()!= WL_CONNECTED){
    delay(500);
    Serial.print(".");
  }
  Serial.println();
  Serial.print("WiFi connected, IP: ");
  Serial.println(WiFi.localIP());

  display.clearDisplay();
  display.setCursor(0,0);
  display.println("Kitkraft.in");
  display.println("WiFi connected:");
  display.println(WiFi.localIP());
  display.display();
  delay(2000);

  server.on("/", [](){
    int percent = map(gasValue, 0, 1023, 0, 100);
    String barColor = (gasValue >= gasThreshold) ? "red" : "green";
    String alertHtml = (gasValue >= gasThreshold) 
        ? "<div class='alert-banner'>ALERT! Gas Detected - Exhaust activated.</div>" 
        : "<div class='normal-banner'>Gas level normal</div>";

    String exhaustStatus = digitalRead(relayPin) == HIGH ? "ON" : "OFF";

    // NEW status logic:
    String statusIcon = (gasValue >= gasThreshold) ? "&#x26A0;" : "&#x2705;";
    String statusText = (gasValue >= gasThreshold) ? "High Gas Detected" : "Gas Level Normal";

    String html = FPSTR(webpage);
    html.replace("%GAS_VALUE%", String(gasValue));
    html.replace("%PERCENT%", String(percent));
    html.replace("%BARCOLOR%", barColor);
    html.replace("%ALERT%", alertHtml);
    html.replace("%EXHAUST_STATUS%", exhaustStatus);

    // Add these two replacements:
    html.replace("%STATUS_ICON%", statusIcon);
    html.replace("%GAS_STATUS_TEXT%", statusText);

    server.send(200, "text/html", html);
  });


  server.begin();
  Serial.println("Web server started");
}

void loop(){
  gasValue = analogRead(mq2Pin);
  if(gasValue>=gasThreshold){
    digitalWrite(relayPin,HIGH);
  } else {
    digitalWrite(relayPin,LOW);
  }
  updateOLED(gasValue);
  server.handleClient();
  delay(500);
}
